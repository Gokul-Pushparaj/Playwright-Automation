name: Enterprise Playwright Automation

on:
  push:
    paths:
      - 'testscripts/*.spec.ts'

jobs:

  test:

    runs-on: ubuntu-latest

    steps:

    # --------------------------------
    # Checkout repository
    # --------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4


    # --------------------------------
    # Setup Node
    # --------------------------------
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20


    # --------------------------------
    # Install dependencies
    # --------------------------------
    - name: Install dependencies
      run: npm install


    # --------------------------------
    # Install Playwright browsers
    # --------------------------------
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps


    # --------------------------------
    # Detect latest generated test file
    # --------------------------------
    - name: Detect latest test file
      run: |

        LATEST_TEST=$(ls -t testscripts/*.spec.ts | head -1)

        echo "LATEST_TEST=$LATEST_TEST" >> $GITHUB_ENV

        FILE_NAME=$(basename "$LATEST_TEST")

        ISSUE_KEY=$(echo "$FILE_NAME" | grep -oE '[A-Z]+-[0-9]+')

        echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV
        echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV

        echo "Latest test file: $FILE_NAME"
        echo "Issue key: $ISSUE_KEY"


    # --------------------------------
    # Run ONLY latest test
    # --------------------------------
    - name: Run Playwright test (Latest only)
      run: |

        echo "Running test file: $LATEST_TEST"

        npx playwright test "$LATEST_TEST" \
          --reporter=json,html \
          > result.json || true

        if [ ! -f result.json ]; then
          echo '{"stats":{"expected":0,"unexpected":0,"skipped":0,"flaky":0,"duration":0}}' > result.json
        fi


    # --------------------------------
    # Upload artifacts
    # --------------------------------
    - name: Upload Test Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: playwright-artifacts
        path: |
          playwright-report/
          test-results/
          result.json
        retention-days: 30


    # --------------------------------
    # Parse Results
    # --------------------------------
    - name: Parse Results
      run: |

        PASSED=$(jq -r '.stats.expected // 0' result.json)
        FAILED=$(jq -r '.stats.unexpected // 0' result.json)
        SKIPPED=$(jq -r '.stats.skipped // 0' result.json)
        FLAKY=$(jq -r '.stats.flaky // 0' result.json)
        DURATION=$(jq -r '.stats.duration // 0' result.json)

        TOTAL=$((PASSED + FAILED + SKIPPED + FLAKY))

        echo "TOTAL=$TOTAL" >> $GITHUB_ENV
        echo "PASSED=$PASSED" >> $GITHUB_ENV
        echo "FAILED=$FAILED" >> $GITHUB_ENV
        echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
        echo "DURATION=$DURATION" >> $GITHUB_ENV

        if [ "$TOTAL" -eq 0 ]; then
          STATUS="âŒ FAILED (NO TESTS EXECUTED)"
        elif [ "$FAILED" -gt 0 ]; then
          STATUS="âŒ FAILED"
        else
          STATUS="âœ… PASSED"
        fi

        echo "STATUS=$STATUS" >> $GITHUB_ENV


    # --------------------------------
    # Generate report URLs
    # --------------------------------
    - name: Generate Report URLs
      run: |

        RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        echo "RUN_URL=$RUN_URL" >> $GITHUB_ENV


    # --------------------------------
    # Post Enterprise comment to Jira
    # --------------------------------
    - name: Post Results to Jira
      if: env.ISSUE_KEY != ''
      run: |

        curl -X POST \
        -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
        -H "Accept: application/json" \
        -H "Content-Type: application/json" \
        --data "{

          \"body\": {

            \"type\": \"doc\",
            \"version\": 1,

            \"content\": [

              {
                \"type\": \"heading\",
                \"attrs\": {\"level\": 3},
                \"content\": [
                  {\"type\": \"text\", \"text\": \"ðŸ¤– AI Automation Execution Report\"}
                ]
              },

              {
                \"type\": \"paragraph\",
                \"content\": [
                  {\"type\": \"text\", \"text\": \"Issue: $ISSUE_KEY\"}
                ]
              },

              {
                \"type\": \"paragraph\",
                \"content\": [
                  {\"type\": \"text\", \"text\": \"Test File: $FILE_NAME\"}
                ]
              },

              {
                \"type\": \"paragraph\",
                \"content\": [
                  {\"type\": \"text\", \"text\": \"Execution Status: $STATUS\"}
                ]
              },

              {
                \"type\": \"paragraph\",
                \"content\": [
                  {\"type\": \"text\", \"text\": \"Total Tests: $TOTAL\"}
                ]
              },

              {
                \"type\": \"paragraph\",
                \"content\": [
                  {\"type\": \"text\", \"text\": \"Passed: $PASSED\"}
                ]
              },

              {
                \"type\": \"paragraph\",
                \"content\": [
                  {\"type\": \"text\", \"text\": \"Failed: $FAILED\"}
                ]
              },

              {
                \"type\": \"paragraph\",
                \"content\": [
                  {\"type\": \"text\", \"text\": \"Skipped: $SKIPPED\"}
                ]
              },

              {
                \"type\": \"paragraph\",
                \"content\": [
                  {\"type\": \"text\", \"text\": \"Execution Time: $DURATION ms\"}
                ]
              },

              {
                \"type\": \"paragraph\",
                \"content\": [
                  {
                    \"type\": \"text\",
                    \"text\": \"ðŸ“Š Full Execution Report: $RUN_URL\"
                  }
                ]
              },

              {
                \"type\": \"paragraph\",
                \"content\": [
                  {
                    \"type\": \"text\",
                    \"text\": \"Generated by Enterprise AI Automation Framework\"
                  }
                ]
              }

            ]
          }

        }" \
        "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE_KEY}/comment"


    # --------------------------------
    # Fail workflow if failed
    # --------------------------------
    - name: Fail workflow if tests failed
      if: env.FAILED != '0' || env.TOTAL == '0'
      run: exit 1