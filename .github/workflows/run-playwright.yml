name: Enterprise Playwright Automation

on:
  push:
    paths:
      - 'testscripts/*.spec.ts'

jobs:

  test:

    runs-on: ubuntu-latest

    timeout-minutes: 30

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:

    # --------------------------------
    # Checkout repository
    # --------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4


    # --------------------------------
    # Setup Node
    # --------------------------------
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20


    # --------------------------------
    # Install dependencies
    # --------------------------------
    - name: Install dependencies
      run: npm ci


    # --------------------------------
    # Install Playwright browsers
    # --------------------------------
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps


    # --------------------------------
    # Detect latest test file (deterministic)
    # --------------------------------
    - name: Detect latest test file
      run: |

        TEST_FILE=$(ls -t testscripts/*.spec.ts | head -n 1)

        ISSUE_KEY=$(basename "$TEST_FILE" | grep -oE '[A-Z]+-[0-9]+')

        echo "TEST_FILE=$TEST_FILE" >> $GITHUB_ENV
        echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV

        echo "Detected:"
        echo "Test file: $TEST_FILE"
        echo "Issue key: $ISSUE_KEY"


    # --------------------------------
    # Run Playwright test (correct + deterministic)
    # --------------------------------
    - name: Run Playwright test
      run: |

        echo "Running test..."

        npx playwright test "$TEST_FILE" \
          --reporter=json,html \
          --workers=1 \
          --timeout=60000 \
          > result.json || true

        echo "Result.json:"
        cat result.json


    # --------------------------------
    # Upload artifacts
    # --------------------------------
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: playwright-artifacts-${{ env.ISSUE_KEY }}
        path: |
          playwright-report/
          test-results/
          result.json
        retention-days: 30


    # --------------------------------
    # Parse Results (enterprise-safe)
    # --------------------------------
    - name: Parse Results
      run: |

        PASSED=$(jq -r '.stats.expected // 0' result.json)
        FAILED=$(jq -r '.stats.unexpected // 0' result.json)
        SKIPPED=$(jq -r '.stats.skipped // 0' result.json)
        FLAKY=$(jq -r '.stats.flaky // 0' result.json)
        DURATION=$(jq -r '.stats.duration // 0' result.json)

        TOTAL=$((PASSED + FAILED + SKIPPED + FLAKY))

        echo "TOTAL=$TOTAL" >> $GITHUB_ENV
        echo "PASSED=$PASSED" >> $GITHUB_ENV
        echo "FAILED=$FAILED" >> $GITHUB_ENV
        echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
        echo "FLAKY=$FLAKY" >> $GITHUB_ENV
        echo "DURATION=$DURATION" >> $GITHUB_ENV

        if [ "$TOTAL" -eq 0 ]; then
          STATUS="âŒ FAILED (NO TESTS)"
        elif [ "$FAILED" -gt 0 ]; then
          STATUS="âŒ FAILED"
        else
          STATUS="âœ… PASSED"
        fi

        echo "STATUS=$STATUS" >> $GITHUB_ENV

        echo "STATUS: $STATUS"


    # --------------------------------
    # Deploy report to GitHub Pages
    # --------------------------------
    - name: Deploy report
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: playwright-report
        destination_dir: ${{ env.ISSUE_KEY }}
        keep_files: true


    # --------------------------------
    # Generate Pages URL
    # --------------------------------
    - name: Generate Report URL
      run: |

        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${ISSUE_KEY}/index.html"

        echo "REPORT_URL=$REPORT_URL" >> $GITHUB_ENV

        echo "Report URL:"
        echo "$REPORT_URL"


    # --------------------------------
    # Post Jira Comment
    # --------------------------------
    - name: Post Results to Jira
      run: |

        curl -X POST \
          -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data "{
            \"body\": {
              \"type\": \"doc\",
              \"version\": 1,
              \"content\": [

                {
                  \"type\": \"heading\",
                  \"attrs\": {\"level\": 3},
                  \"content\": [
                    {\"type\": \"text\", \"text\": \"ðŸ¤– AI Automation Execution Report\"}
                  ]
                },

                {
                  \"type\": \"paragraph\",
                  \"content\": [
                    {\"type\": \"text\", \"text\": \"Issue: $ISSUE_KEY\"}
                  ]
                },

                {
                  \"type\": \"paragraph\",
                  \"content\": [
                    {\"type\": \"text\", \"text\": \"Execution Status: $STATUS\"}
                  ]
                },

                {
                  \"type\": \"paragraph\",
                  \"content\": [
                    {
                      \"type\": \"text\",
                      \"text\": \"Total: $TOTAL | Passed: $PASSED | Failed: $FAILED\"
                    }
                  ]
                },

                {
                  \"type\": \"paragraph\",
                  \"content\": [
                    {
                      \"type\": \"text\",
                      \"text\": \"Execution Time: $DURATION ms\"
                    }
                  ]
                },

                {
                  \"type\": \"paragraph\",
                  \"content\": [
                    {
                      \"type\": \"text\",
                      \"text\": \"ðŸ“Š Full Report: $REPORT_URL\"
                    }
                  ]
                }

              ]
            }
          }" \
          "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE_KEY}/comment"


    # --------------------------------
    # Transition Jira â†’ DONE if passed
    # --------------------------------
    - name: Transition Jira to Done
      if: env.FAILED == '0' && env.TOTAL != '0'
      run: |

        echo "Transitioning Jira to Done"

        curl -X POST \
          -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data '{
            "transition": {
              "id": "31"
            }
          }' \
          "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE_KEY}/transitions"


    # --------------------------------
    # Transition Jira â†’ In Progress if failed
    # --------------------------------
    - name: Transition Jira to In Progress
      if: env.FAILED != '0'
      run: |

        echo "Transitioning Jira to In Progress"

        curl -X POST \
          -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data '{
            "transition": {
              "id": "21"
            }
          }' \
          "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE_KEY}/transitions"


    # --------------------------------
    # Fail workflow if tests failed
    # --------------------------------
    - name: Fail workflow
      if: env.FAILED != '0'
      run: exit 1